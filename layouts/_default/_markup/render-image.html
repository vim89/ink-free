{{- $src := .Destination -}}
{{- $alt := .Text -}}
{{- $title := .Title -}}

{{- /* Try to get the image resource */ -}}
{{- $img := "" -}}
{{- if strings.HasPrefix $src "/" -}}
  {{- /* Absolute path - try to find in static or assets */ -}}
  {{- $img = resources.Get (strings.TrimPrefix "/" $src) -}}
  {{- if not $img -}}
    {{- $img = .Page.Resources.GetMatch $src -}}
  {{- end -}}
{{- else -}}
  {{- /* Relative path - look in page bundle */ -}}
  {{- $img = .Page.Resources.GetMatch $src -}}
{{- end -}}

{{- if $img -}}
  {{- /* Generate responsive versions */ -}}
  {{- $small := $img.Resize "480x webp q85" -}}
  {{- $medium := $img.Resize "768x webp q85" -}}
  {{- $large := $img.Resize "1200x webp q85" -}}
  {{- $fallback := $img.Resize "1200x q85" -}}

  {{- /* Try AVIF if supported */ -}}
  {{- $avifSmall := "" -}}
  {{- $avifMedium := "" -}}
  {{- $avifLarge := "" -}}
  {{- with $img.Resize "480x avif q80" -}}{{ $avifSmall = . }}{{- end -}}
  {{- with $img.Resize "768x avif q80" -}}{{ $avifMedium = . }}{{- end -}}
  {{- with $img.Resize "1200x avif q80" -}}{{ $avifLarge = . }}{{- end -}}

  {{ if $title }}
  <figure>
    <picture>
      {{- if $avifSmall -}}
      <source
        type="image/avif"
        srcset="{{ $avifSmall.RelPermalink }} 480w, {{ $avifMedium.RelPermalink }} 768w, {{ $avifLarge.RelPermalink }} 1200w"
        sizes="(max-width: 480px) 100vw, (max-width: 768px) 100vw, 1200px">
      {{- end -}}
      <source
        type="image/webp"
        srcset="{{ $small.RelPermalink }} 480w, {{ $medium.RelPermalink }} 768w, {{ $large.RelPermalink }} 1200w"
        sizes="(max-width: 480px) 100vw, (max-width: 768px) 100vw, 1200px">
      <img
        src="{{ $fallback.RelPermalink }}"
        alt="{{ $alt }}"
        loading="lazy"
        width="{{ $img.Width }}"
        height="{{ $img.Height }}"
        class="figcaption-img">
    </picture>
    <figcaption>{{ $title }}</figcaption>
  </figure>
  {{ else }}
  <picture>
    {{- if $avifSmall -}}
    <source
      type="image/avif"
      srcset="{{ $avifSmall.RelPermalink }} 480w, {{ $avifMedium.RelPermalink }} 768w, {{ $avifLarge.RelPermalink }} 1200w"
      sizes="(max-width: 480px) 100vw, (max-width: 768px) 100vw, 1200px">
    {{- end -}}
    <source
      type="image/webp"
      srcset="{{ $small.RelPermalink }} 480w, {{ $medium.RelPermalink }} 768w, {{ $large.RelPermalink }} 1200w"
      sizes="(max-width: 480px) 100vw, (max-width: 768px) 100vw, 1200px">
    <img
      src="{{ $fallback.RelPermalink }}"
      alt="{{ $alt }}"
      loading="lazy"
      width="{{ $img.Width }}"
      height="{{ $img.Height }}">
  </picture>
  {{ end }}
{{- else -}}
  {{- /* Fallback for external images or when processing fails */ -}}
  {{ if $title }}
  <figure>
    <img src="{{ $src | safeURL }}" alt="{{ $alt }}" loading="lazy" class="figcaption-img">
    <figcaption>{{ $title }}</figcaption>
  </figure>
  {{ else }}
  <img src="{{ $src | safeURL }}" alt="{{ $alt }}" loading="lazy">
  {{ end }}
{{- end -}}
