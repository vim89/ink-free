<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge">

	<script>
	// Early theme init: avoid FOUC by setting dark class before CSS
	(function(){
	  try {
	    var mode = {{ printf "%q" .Site.Params.mode }} || "auto";
	    var ls = null;
	    try { ls = localStorage.getItem('theme'); } catch(e) {}
	    var prefersDark = false;
	    try { prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches; } catch(e) {}
	    var useDark = (ls === 'dark') || (!ls && (mode === 'dark' || (mode === 'auto' && prefersDark)));
	    if (useDark) document.documentElement.classList.add('dark');
	  } catch(e) {}
	})();
	</script>

	{{- /* Security Headers and CSP */ -}}
	{{- partial "security-headers.html" . -}}
	{{- $title := ( .Title ) -}}
	{{- $siteTitle := ( .Site.Title ) -}}
	{{- if .IsHome -}}
	<title>{{ $siteTitle }} {{ if isset .Site.Params "subtitle" }}- {{ .Site.Params.Subtitle }}{{ end }} </title>
	{{- else -}}
	<title>{{ $title }} - {{ $siteTitle }}</title>
	{{- end -}}

	{{- /* Modern Favicon Implementation */ -}}
	{{- if isset .Site.Params "favicon" -}}
		<link rel="icon" type="image/x-icon" href="/{{ .Site.Params.favicon }}">
		<link rel="shortcut icon" type="image/x-icon" href="/{{ .Site.Params.favicon }}">
		<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
		<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
		<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
		<link rel="manifest" href="/site.webmanifest">
		<meta name="theme-color" content="#007acc">
		<meta name="msapplication-TileColor" content="#007acc">
		<meta name="msapplication-config" content="/browserconfig.xml">
	{{- else -}}
		<link rel="icon" type="image/x-icon" href="/favicon.ico">
		<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
	{{- end -}}

	<meta name="viewport" content="width=device-width, initial-scale=1">
	{{- /* Meta description for SEO */ -}}
	{{- if .IsHome -}}
	<meta name="description" content="{{ .Site.Params.description }}">
	{{- else if .Description -}}
	<meta name="description" content="{{ .Description }}">
	{{- else if .Summary -}}
	<meta name="description" content="{{ .Summary | truncate 160 }}">
	{{- else -}}
	<meta name="description" content="{{ .Site.Params.description }}">
	{{- end -}}
	{{ with .OutputFormats.Get "rss" -}}
	{{ printf `
	<link rel="%s" type="%s" href="%s" title="%s" />` .Rel .MediaType.Type .Permalink $.Site.Title | safeHTML }}
	{{ end -}}

	{{- template "_internal/schema.html" . -}}
	{{- template "_internal/opengraph.html" . -}}
	{{- template "_internal/twitter_cards.html" . -}}
	{{- /* Hugo Pipes CSS with SRI */ -}}
	{{- $normalize := resources.Get "css/normalize.css" -}}
	{{- $main := resources.Get "css/main.css" -}}
	{{- $markdown := resources.Get "css/github-markdown.css" -}}
	{{- $codeblocks := resources.Get "css/github-codeblocks.css" -}}

	{{- /* Bundle ALL CSS files to reduce render-blocking requests */ -}}
	{{- $allCSS := slice $normalize $main $markdown $codeblocks -}}

	{{- /* Add tags CSS if on taxonomy pages */ -}}
	{{- if or (eq .Kind "taxonomy") (eq .Kind "term") -}}
		{{- $tagsCSS := resources.Get "css/tags.css" -}}
		{{- if $tagsCSS -}}
			{{- $allCSS = $allCSS | append $tagsCSS -}}
		{{- end -}}
	{{- end -}}

	{{- /* Add custom CSS */ -}}
	{{- if isset .Site.Params "customcss" -}}
		{{- range .Site.Params.customCSS -}}
			{{- $customCSS := resources.Get . -}}
			{{- if $customCSS -}}
				{{- $allCSS = $allCSS | append $customCSS -}}
			{{- end -}}
		{{- end -}}
	{{- end -}}

	{{- /* Add dark mode CSS */ -}}
	{{- $darkCSS := resources.Get "css/dark.css" -}}
	{{- if $darkCSS -}}
		{{- $allCSS = $allCSS | append $darkCSS -}}
	{{- end -}}

	{{- /* Add conditional CSS files */ -}}
	{{- if .Site.Params.enablePagefind -}}
		{{- $searchCSS := resources.Get "css/search.css" -}}
		{{- if $searchCSS -}}
			{{- $allCSS = $allCSS | append $searchCSS -}}
		{{- end -}}
	{{- end -}}

	{{- if eq .Layout "topic-hub" -}}
		{{- $topicCSS := resources.Get "css/topic-hub.css" -}}
		{{- if $topicCSS -}}
			{{- $allCSS = $allCSS | append $topicCSS -}}
		{{- end -}}
	{{- end -}}

    {{- /* Series-specific CSS */ -}}
    {{- if eq .Type "series" -}}
        {{- $seriesCSS := resources.Get "css/series.css" -}}
        {{- if $seriesCSS -}}
            {{- $allCSS = $allCSS | append $seriesCSS -}}
        {{- end -}}
    {{- end -}}

	{{- $accessibilityCSS := resources.Get "css/accessibility.css" -}}
	{{- if $accessibilityCSS -}}
		{{- $allCSS = $allCSS | append $accessibilityCSS -}}
	{{- end -}}

	{{- if or (eq .Type "about") (in .RelPermalink "/about") -}}
		{{- $authorEEATCSS := resources.Get "css/author-eeat.css" -}}
		{{- if $authorEEATCSS -}}
			{{- $allCSS = $allCSS | append $authorEEATCSS -}}
		{{- end -}}
	{{- end -}}

	{{- $aestheticCSS := resources.Get "css/aesthetic-refinements.css" -}}
	{{- if $aestheticCSS -}}
		{{- $allCSS = $allCSS | append $aestheticCSS -}}
	{{- end -}}

	{{- /* Bundle all CSS into single file */ -}}
	{{- $bundledCSS := $allCSS | resources.Concat "css/bundle.css" | resources.Minify | resources.Fingerprint -}}

	{{- /* Critical CSS inlined for faster rendering */ -}}
	<style>
	body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;line-height:1.6;color:#212121;margin:0;padding:0}
	.container{max-width:900px;margin:0 auto;padding:0 1rem}
	.header{text-align:center;padding:2rem 0}
	.site-title{margin:0.5rem 0;font-size:2rem}
	.site-title a{color:#212121;text-decoration:none}
	@media (prefers-color-scheme:dark){body{color:#e0e0e0;background:#1a1a1a}.site-title a{color:#e0e0e0}}
	.dark{color:#e0e0e0;background:#1a1a1a}
	.dark .site-title a{color:#e0e0e0}
	</style>

	<link rel="preload" href="{{ $bundledCSS.RelPermalink }}" as="style" onload="this.onload=null;this.rel='stylesheet'" integrity="{{ $bundledCSS.Data.Integrity }}">
	<noscript><link rel="stylesheet" href="{{ $bundledCSS.RelPermalink }}" integrity="{{ $bundledCSS.Data.Integrity }}"></noscript>

	{{- $enableUmami := and (isset .Site.Params "enableumami") (.Site.Params.enableUmami) -}}
	{{- $hasURL := isset .Site.Params "umamiurl" -}}
	{{- $hasID := isset .Site.Params "umamiwebsiteid" -}}
	{{- if and $enableUmami $hasURL $hasID -}}
	<script defer src="{{ .Site.Params.umamiURL }}" data-website-id="{{ .Site.Params.umamiWebsiteId }}"
		data-tag="blog"></script>
	{{- end -}}
	{{- /* JavaScript assets with Hugo Pipes and SRI */ -}}
	{{ if and (isset .Site.Params "social") (isset .Site.Params "feathericonscdn") (eq .Site.Params.featherIconsCDN true) -}}
		{{- /* CDN version with SRI */ -}}
		<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"
		        integrity="sha384-uO3SXW5IuS1ZpFPKugNNWqTZRRglnUJK6UAZ/gxOX80nxEkN9NcGZTftn6RzhGWE"
		        crossorigin="anonymous" defer></script>
	{{- else if (isset .Site.Params "social") -}}
		{{- /* Local feather icons */ -}}
		{{- $feather := resources.Get "js/feather.min.js" -}}
		{{- if $feather -}}
			{{- $featherProcessed := $feather | resources.Minify | resources.Fingerprint -}}
			<script src="{{ $featherProcessed.RelPermalink }}" integrity="{{ $featherProcessed.Data.Integrity }}" defer></script>
		{{- end -}}
	{{ end }}

	{{- /* Main theme JavaScript */ -}}
	{{- $mainJS := resources.Get "js/main.js" -}}
	{{- if $mainJS -}}
		{{- $mainJSProcessed := $mainJS | resources.Minify | resources.Fingerprint -}}
		<script src="{{ $mainJSProcessed.RelPermalink }}" integrity="{{ $mainJSProcessed.Data.Integrity }}" defer></script>
	{{- end -}}

	{{- /* Custom JavaScript if defined */ -}}
	{{- if isset .Site.Params "customjs" -}}
		{{- range .Site.Params.customJS -}}
			{{- $customJS := resources.Get . -}}
			{{- if $customJS -}}
				{{- $customJSProcessed := $customJS | resources.Minify | resources.Fingerprint -}}
				<script src="{{ $customJSProcessed.RelPermalink }}" integrity="{{ $customJSProcessed.Data.Integrity }}" defer></script>
			{{- end -}}
		{{- end -}}
	{{- end -}}
</head>
